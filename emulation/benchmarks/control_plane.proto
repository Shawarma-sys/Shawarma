syntax = "proto3";

package control_plane;

service ControlPlane {
    rpc SendModelUpdate (Empty) returns (ModelUpdateRequest); // Fix return type to ModelUpdateRequest
    rpc ReceiveData (DataRequest) returns (Empty);
    rpc WarmupGPU (Empty) returns (Empty); // Add WarmupGPU method
    rpc RecordExperimentData (ExperimentDataRequest) returns (Empty); // Add RecordExperimentData method
    rpc RequestRetraining (RetrainingRequest) returns (Empty); // Add RequestRetraining method
    rpc Shutdown(Empty) returns (Empty); // Add Shutdown method
}

service DataPlane {
    rpc UpdateModel (ModelUpdateRequest) returns (Empty);
    rpc UpdateLincRules (LincRulesRequest) returns (Empty);
}

message ModelUpdateRequest {
    bytes model_state = 1;
}

message LincRule {
    repeated float pattern = 1;
    repeated int32 important_features = 2;
    int32 class_label = 3;
    float confidence = 4;
}

message LincRulesRequest {
    repeated LincRule rules = 1;
}

message DataRequest {
    repeated float features = 1;
    repeated float labels = 2;
    int32 window_index = 3;
    float sleep_time = 4; // Add sleep_time field for data plane to control plane communication
}

message ExperimentDataRequest {
    float my_improvement = 1;
    repeated float my_f1s = 2;
    repeated float my_f1s_proxy = 3;
    repeated float static_f1s = 4;
    int32 window_index = 5;
    repeated float my_accuracy = 6;
    repeated float static_accuracy = 7;
}

message Tensor {
    repeated float data = 1;
    repeated int32 shape = 2; // 表示张量的维度
}

message RetrainingRequest {
    int32 window_index = 1;
    Tensor features = 2;
    repeated float my_labels = 3; // 数据平面模型的预测标签
    float my_window_f1 = 4; // 数据面在该窗口的模型F1值，作为 F1_d 传递
    repeated float ground_truth_labels = 5; // 可选：真实标签，用于直接判断漂移
}

message Empty {}
